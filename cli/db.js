const path = require('path')
const low = require('lowdb')
const FileAsync = require('lowdb/adapters/FileAsync')

module.exports.ensureDB = async ({ workspace, isBackup, namespace }) => {
  const file = path.join(workspace, `${namespace}${isBackup ? '.backupDB' : '.activeDB'}.json`)
  const adapter = new FileAsync(file)
  const db = await low(adapter)
  let template = {
    _id: '_' + Math.random().toString(36).substr(2, 9),
    IMPORTANT_MSG0: "===== DO NOT EDIT THIS FILE WHEN SERVER IS ACTIVE =====",
    current: {
      effectnode: require('../package.json').version,
      dateCreated: new Date().getTime(),
      db: {}
    },
    versions: [],
    IMPORTANT_MSG1: "===== DO NOT EDIT THIS FILE WHEN SERVER IS ACTIVE ====="
  }
  if (isBackup) {
    delete template.current
  } else {
    delete template.versions
  }

  db.defaults(template).write()
  return db
}
